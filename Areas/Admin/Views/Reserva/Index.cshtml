@model IEnumerable<StayGo.Models.Reserva>

@{
    ViewData["Title"] = "Gestión de Reservas";
}

<h1>@ViewData["Title"]</h1>

<p>
    <a asp-action="Crear" class="btn btn-primary">Crear Nueva Reserva</a>
</p>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="card">
    <div class="card-body">
        <table class="table table-striped table-hover" id="reservasTable">
            <thead class="table-dark">
                <tr>
                    <th>Propiedad / Habitación</th>
                    <th>Cliente</th>
                    <th>Fechas</th>
                    <th>Huéspedes</th>
                    <th>Precio Total</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>
                            <div class="fw-bold">@Html.DisplayFor(modelItem => item.Propiedad.Titulo)</div>
                            <small class="text-muted">@item.Propiedad.Tipo</small>
                            @if (item.Habitacion != null)
                            {
                                <div class="mt-1">
                                    <span class="badge bg-secondary">Habitación: @item.Habitacion.Nombre</span>
                                </div>
                            }
                            else
                            {
                                <div class="mt-1">
                                    <span class="badge bg-light text-dark">Propiedad completa</span>
                                </div>
                            }
                        </td>
                        <td>
                            <div>@Html.DisplayFor(modelItem => item.Usuario.Email)</div>
                            <small class="text-muted">@item.Usuario.FirstName @item.Usuario.LastName</small>
                        </td>
                        <td>
                            <div class="fw-bold">@item.CheckIn.ToString("dd/MM/yyyy")</div>
                            <div class="text-muted">al</div>
                            <div class="fw-bold">@item.CheckOut.ToString("dd/MM/yyyy")</div>
                            <small class="text-muted">
                                (@((item.CheckOut.DayNumber - item.CheckIn.DayNumber)) noches)
                            </small>
                        </td>
                        <td>
                            <span class="badge bg-primary">@item.Huespedes huésped(es)</span>
                        </td>
                        <td>
                            <span class="fw-bold text-success">$@item.PrecioTotal.ToString("N2")</span>
                        </td>
                        <td>
                            @{
                                var badgeClass = item.Estado switch
                                {
                                    StayGo.Models.Enums.EstadoReserva.Pendiente => "bg-warning",
                                    StayGo.Models.Enums.EstadoReserva.Confirmada => "bg-success",
                                    StayGo.Models.Enums.EstadoReserva.Cancelada => "bg-danger",
                                    StayGo.Models.Enums.EstadoReserva.Rechazada => "bg-dark",
                                    StayGo.Models.Enums.EstadoReserva.Finalizada => "bg-secondary",
                                    _ => "bg-light text-dark"
                                };

                                var estadoTexto = item.Estado switch
                                {
                                    StayGo.Models.Enums.EstadoReserva.Pendiente => "Pendiente",
                                    StayGo.Models.Enums.EstadoReserva.Confirmada => "Confirmada",
                                    StayGo.Models.Enums.EstadoReserva.Cancelada => "Cancelada",
                                    StayGo.Models.Enums.EstadoReserva.Rechazada => "Rechazada",
                                    StayGo.Models.Enums.EstadoReserva.Finalizada => "Finalizada",
                                    _ => item.Estado.ToString()
                                };
                            }
                            <span class="badge @badgeClass">@estadoTexto</span>
                            
                            @* Mostrar badge "En curso" para reservas confirmadas que están activas *@
                            @if (item.Estado == StayGo.Models.Enums.EstadoReserva.Confirmada && 
                                 item.CheckIn <= DateOnly.FromDateTime(DateTime.Today) && 
                                 item.CheckOut >= DateOnly.FromDateTime(DateTime.Today))
                            {
                                <div class="mt-1">
                                    <span class="badge bg-info">En curso</span>
                                </div>
                            }
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-outline-warning" title="Editar reserva">
                                    <i class="fas fa-edit"></i> Editar
                                </a>
                                
                                @* Mostrar botón Cancelar solo para reservas pendientes o confirmadas *@
                                @if (item.Estado == StayGo.Models.Enums.EstadoReserva.Pendiente || 
                                     item.Estado == StayGo.Models.Enums.EstadoReserva.Confirmada)
                                {
                                    <a asp-action="Cancel" asp-route-id="@item.Id" class="btn btn-outline-danger" title="Cancelar reserva">
                                        <i class="fas fa-times"></i> Cancelar
                                    </a>
                                }
                                
                                @* Botón para marcar como Finalizada *@
                                @if (item.Estado == StayGo.Models.Enums.EstadoReserva.Confirmada && 
                                     item.CheckOut < DateOnly.FromDateTime(DateTime.Today))
                                {
                                    <form asp-action="Finalizar" asp-route-id="@item.Id" method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-outline-success btn-sm" title="Marcar como finalizada">
                                            <i class="fas fa-check"></i> Finalizar
                                        </button>
                                    </form>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Filtros -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="card-title mb-0">Filtros</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <label class="form-label">Estado:</label>
                <select class="form-select" id="estadoFilter">
                    <option value="">Todos los estados</option>
                    <option value="Pendiente">Pendiente</option>
                    <option value="Confirmada">Confirmada</option>
                    <option value="Cancelada">Cancelada</option>
                    <option value="Rechazada">Rechazada</option>
                    <option value="Finalizada">Finalizada</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Tipo Propiedad:</label>
                <select class="form-select" id="tipoFilter">
                    <option value="">Todos los tipos</option>
                    <option value="Hotel">Hotel</option>
                    <option value="Casa">Casa</option>
                    <option value="Departamento">Departamento</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Mostrar:</label>
                <select class="form-select" id="mostrarFilter">
                    <option value="todas">Todas las reservas</option>
                    <option value="hoy">Reservas de hoy</option>
                    <option value="futuras">Futuras reservas</option>
                    <option value="pasadas">Reservas pasadas</option>
                </select>
            </div>
        </div>
    </div>
</div>

<!-- Estadísticas rápidas -->
<div class="row mt-4">
    <div class="col-md-2">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <h5 class="card-title">@Model.Count()</h5>
                <p class="card-text">Total Reservas</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <h5 class="card-title">@Model.Count(r => r.Estado == StayGo.Models.Enums.EstadoReserva.Pendiente)</h5>
                <p class="card-text">Pendientes</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h5 class="card-title">@Model.Count(r => r.Estado == StayGo.Models.Enums.EstadoReserva.Confirmada)</h5>
                <p class="card-text">Confirmadas</p>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card text-white bg-info">
            <div class="card-body">
                <h5 class="card-title">@Model.Count(r => r.Estado == StayGo.Models.Enums.EstadoReserva.Confirmada && r.CheckIn <= DateOnly.FromDateTime(DateTime.Today) && r.CheckOut >= DateOnly.FromDateTime(DateTime.Today))</h5>
                <p class="card-text">En curso</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Filtro por estado
            $('#estadoFilter').change(function() {
                var estado = $(this).val();
                $('#reservasTable tbody tr').show();
                
                if (estado) {
                    $('#reservasTable tbody tr').each(function() {
                        var rowEstado = $(this).find('td:nth-child(6) .badge').first().text().trim();
                        if (rowEstado !== estado) {
                            $(this).hide();
                        }
                    });
                }
            });

            // Filtro por tipo de propiedad
            $('#tipoFilter').change(function() {
                var tipo = $(this).val();
                $('#reservasTable tbody tr').show();
                
                if (tipo) {
                    $('#reservasTable tbody tr').each(function() {
                        var rowTipo = $(this).find('td:first .text-muted').text().trim();
                        if (rowTipo !== tipo) {
                            $(this).hide();
                        }
                    });
                }
            });

            // Filtro por fecha
            $('#mostrarFilter').change(function() {
                var filtro = $(this).val();
                var hoy = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                
                $('#reservasTable tbody tr').show();
                
                if (filtro === 'hoy') {
                    $('#reservasTable tbody tr').each(function() {
                        var checkIn = $(this).find('td:nth-child(3) div:first').text().trim();
                        var checkOut = $(this).find('td:nth-child(3) div:last').text().trim();
                        
                        // Simple check - podrías mejorar esta lógica
                        if (checkIn !== hoy && checkOut !== hoy) {
                            $(this).hide();
                        }
                    });
                }
            });

            // Auto-ocultar alertas después de 5 segundos
            setTimeout(function() {
                $('.alert').fadeOut('slow');
            }, 5000);
        });
    </script>

    <style>
        .table th {
            border-top: none;
            font-weight: 600;
        }
        
        .badge {
            font-size: 0.75em;
        }
        
        .btn-group-sm > .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        #reservasTable tbody tr:hover {
            background-color: #f8f9fa;
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }
        
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
        }
    </style>
}