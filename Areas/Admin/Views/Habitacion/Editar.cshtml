@model StayGo.Models.Habitacion
@using StayGo.Models.Enums
@{
    ViewData["Title"] = "Editar habitación";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}
@section Styles{
<style>
  .card-soft{ border-radius:16px; border:1px solid #edf1ee; background:#fff; box-shadow:0 8px 20px rgba(36,48,54,.05); }
  .btn-sage{ background:var(--sage-700); color:#fff; border:1px solid var(--sage-700); }
  .btn-sage:hover{ background:var(--sage-800); border-color:var(--sage-800); }
  .btn-outline-sage{ border:1px solid var(--sage-400); color:var(--sage-700); background:#fff; }
  .btn-outline-sage:hover{ background:var(--sage-100); border-color:var(--sage-500); color:var(--sage-800); }

  .imagen-item {
    background: #f8faf9;
    border: 1px solid #e0e8e6;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
  }
  .imagen-item:hover {
    background: #f0f3f2;
    border-color: var(--sage-400);
  }
  .url-input {
    border: 1px solid #d0d8d5;
    border-radius: 6px;
  }
  .url-input:focus {
    border-color: var(--sage-500);
    box-shadow: 0 0 0 0.2rem rgba(107, 140, 127, 0.25);
  }
</style>
}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="h5 m-0">Editar habitación</h2>
  <a asp-area="Admin" asp-controller="Propiedad" asp-action="Detalles" asp-route-id="@Model.PropiedadId" class="btn btn-outline-sage">
    <i class="bi bi-arrow-left me-1"></i> Volver a la propiedad
  </a>
</div>

<form asp-area="Admin" asp-controller="Habitacion" asp-action="Editar" method="post" class="card-soft p-3">
  @Html.AntiForgeryToken()
  <input type="hidden" asp-for="Id" />
  <input type="hidden" asp-for="PropiedadId" />
  <div asp-validation-summary="All" class="text-danger mb-2"></div>

  <div class="row g-3">
    <div class="col-md-6">
      <label class="form-label">Nombre</label>
      <input asp-for="Nombre" class="form-control" />
      <span asp-validation-for="Nombre" class="text-danger"></span>
    </div>
    <div class="col-md-3">
      <label class="form-label">Capacidad</label>
      <input asp-for="Capacidad" type="number" min="1" class="form-control" />
      <span asp-validation-for="Capacidad" class="text-danger"></span>
    </div>
    <div class="col-md-3">
      <label class="form-label">Precio por noche (S/)</label>
      <input asp-for="PrecioPorNoche" type="number" step="0.01" min="0" class="form-control" />
      <span asp-validation-for="PrecioPorNoche" class="text-danger"></span>
    </div>
    <div class="col-md-3">
      <label class="form-label">Piso</label>
      <input asp-for="Piso" type="number" class="form-control" />
    </div>
    <div class="col-md-3">
      <label class="form-label">Número</label>
      <input asp-for="Numero" class="form-control" />
    </div>
    <div class="col-md-6">
      <label class="form-label">Tipo de cama</label>
      <select asp-for="TipoCama" class="form-select" asp-items="Html.GetEnumSelectList<TipoCama>()"></select>
    </div>
  </div>

  <!-- SECCIÓN DE IMÁGENES -->
  <div class="mt-5 pt-4 border-top">
    <h5 class="section-title mb-3">
      <i class="bi bi-images me-2"></i>Imágenes de la Habitación
    </h5>
    <div id="imagenes-list" class="mb-3">
      @if (Model?.Imagenes?.Any() == true)
      {
        @foreach (var img in Model.Imagenes)
        {
          var idx = Model.Imagenes.ToList().IndexOf(img);
          <div class="row g-2 imagen-item align-items-center" data-index="@idx">
            <div class="col-md-8">
              <input name="Imagenes[@idx].Url" class="form-control url-input" value="@img.Url" placeholder="https://..." />
            </div>
            <div class="col-md-3 d-flex align-items-center">
              <div class="form-check">
                <input class="form-check-input principal-radio" type="radio" name="principal" value="@idx" @(img.EsPrincipal ? "checked" : "") />
                <label class="form-check-label">Principal</label>
              </div>
            </div>
            <div class="col-md-1 d-flex align-items-center">
              <button type="button" class="btn btn-outline-danger w-100 btn-remove" title="Quitar">X</button>
            </div>
          </div>
        }
      }
    </div>
    <button type="button" id="btn-add-imagen" class="btn btn-outline-sage">
      <i class="bi bi-plus-circle me-1"></i> Agregar imagen
    </button>
  </div>

  <div class="mt-4 d-flex gap-2">
    <button class="btn btn-sage" type="submit"><i class="bi bi-check2 me-1"></i> Guardar</button>
    <a asp-area="Admin" asp-controller="Habitacion" asp-action="Eliminar"
       asp-route-propiedadId="@Model.PropiedadId" asp-route-id="@Model.Id"
       class="btn btn-outline-danger">Eliminar…</a>
    <a asp-area="Admin" asp-controller="Propiedad" asp-action="Detalles" asp-route-id="@Model.PropiedadId" class="btn btn-outline-secondary">Cancelar</a>
  </div>
</form>

@section Scripts {
<script>
  const list = document.getElementById('imagenes-list');
  const btnAdd = document.getElementById('btn-add-imagen');

  function attachRemoveListener(btn) {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      btn.closest('.imagen-item').remove();
    });
  }

  // Attach listeners a botones existentes
  document.querySelectorAll('.btn-remove').forEach(btn => attachRemoveListener(btn));

  btnAdd.addEventListener('click', (e) => {
    e.preventDefault();
    const idx = list.querySelectorAll('.imagen-item').length;
    const row = document.createElement('div');
    row.className = 'row g-2 imagen-item align-items-center';
    row.setAttribute('data-index', idx);
    row.innerHTML = `
      <div class="col-md-8">
        <input name="Imagenes[${idx}].Url" class="form-control url-input" placeholder="https://..." />
      </div>
      <div class="col-md-3 d-flex align-items-center">
        <div class="form-check">
          <input class="form-check-input principal-radio" type="radio" name="principal" value="${idx}" />
          <label class="form-check-label">Principal</label>
        </div>
      </div>
      <div class="col-md-1 d-flex align-items-center">
        <button type="button" class="btn btn-outline-danger w-100 btn-remove" title="Quitar">X</button>
      </div>
    `;

    const btnRemove = row.querySelector('.btn-remove');
    attachRemoveListener(btnRemove);

    list.appendChild(row);
  });

  // Marcar la primera imagen como principal por defecto
  document.querySelector('form').addEventListener('submit', (e) => {
    const radios = document.querySelectorAll('.principal-radio');
    if (radios.length > 0 && !Array.from(radios).some(r => r.checked)) {
      radios[0].checked = true;
    }

    // Establecer EsPrincipal en los inputs ocultos
    const items = list.querySelectorAll('.imagen-item');
    items.forEach((item, idx) => {
      const radio = item.querySelector('.principal-radio');
      let hiddenInput = item.querySelector('input[name*="EsPrincipal"]');
      if (!hiddenInput) {
        hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = `Imagenes[${idx}].EsPrincipal`;
        item.appendChild(hiddenInput);
      }
      hiddenInput.value = radio.checked ? 'true' : 'false';
    });
  });
</script>
}
