@model StayGo.Models.Propiedad
@using System.Globalization
@using System.Security.Claims
@{
    ViewData["Title"] = Model?.Titulo ?? "Propiedad";
    var cover = Model?.Imagenes?.OrderByDescending(i => i.EsPrincipal).FirstOrDefault()?.Url
                ?? "https://placehold.co/1200x360?text=Sin+imagen";
    var pe = new CultureInfo("es-PE");
    var ubic = string.Join(", ",
        new[] { Model?.Direccion?.Ciudad, Model?.Direccion?.Pais }
        .Where(s => !string.IsNullOrWhiteSpace(s)));
    var rese√±as = (Model?.Resenas ?? Enumerable.Empty<StayGo.Models.Resena>()).OrderByDescending(r => r.Fecha).ToList();
    var tieneResenas = rese√±as.Any();
    var promedio = tieneResenas ? rese√±as.Average(r => r.Puntuacion) : 0.0;
    int promedioEntero = (int)Math.Round(promedio); // para mostrar estrellas redondeadas
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<div class="container py-4">
  <h2 class="mb-2">@Model?.Titulo</h2>

  <div class="text-muted mb-2">
    <i class="bi bi-geo-alt"></i> @ubic
  </div>

  @if (Model?.PrecioPorNoche.HasValue == true)
  {
    <div class="fw-semibold mb-3">
      @Model!.PrecioPorNoche!.Value.ToString("C", pe) <small class="text-muted">/ noche</small>
    </div>
  }
  else
  {
    <span class="badge text-bg-secondary mb-3">Hotel (precio por habitaci√≥n)</span>
  }

  <img src="@cover" class="img-fluid rounded mb-3"
       style="object-fit:cover;max-height:360px;width:100%;" alt="@Model?.Titulo" />

  <p>@Model?.Descripcion</p>

  <div class="border rounded p-3 bg-light my-3">
    <strong>Ubicaci√≥n</strong>
    <div class="small text-muted">Lat: @Model?.Lat, Lng: @Model?.Lng</div>

    <!--RESERVA-->
    @if (User.Identity?.IsAuthenticated ?? false)
    {
        <form asp-area="" asp-controller="Pago" asp-action="Confirmar" method="get" class="row g-2 align-items-end mb-3">
            <input type="hidden" name="propiedadId" value="@Model?.Id" />
            <div class="col-auto">
                <label class="form-label small">Check-in</label>
                <input type="date" name="checkin" class="form-control" value="@DateTime.Today.ToString("yyyy-MM-dd")" required />
            </div>
            <div class="col-auto">
                <label class="form-label small">Check-out</label>
                <input type="date" name="checkout" class="form-control" value="@DateTime.Today.AddDays(1).ToString("yyyy-MM-dd")" required />
            </div>
            <div class="col-auto">
                <label class="form-label small">Hu√©spedes</label>
                <input type="number" name="huespedes" class="form-control" value="1" min="1" />
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-credit-card"></i> Reservar y Pagar
                </button>
            </div>
        </form>
    }
    else
    {
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle"></i>
            <strong>Inicia sesi√≥n para reservar</strong>
            <p class="mb-2 mt-2">Para hacer una reserva, necesitas tener una cuenta en StayGo.</p>
            <a asp-area="Identity" asp-page="/Account/Login"
               asp-route-returnUrl="@($"/Propiedad/Details/{Model?.Id}")"
               class="btn btn-sm btn-primary">
                <i class="bi bi-box-arrow-in-right"></i> Iniciar sesi√≥n
            </a>
            <a asp-area="Identity" asp-page="/Account/Register"
               asp-route-returnUrl="@($"/Propiedad/Details/{Model?.Id}")"
               class="btn btn-sm btn-success">
                <i class="bi bi-person-plus"></i> Crear cuenta
            </a>
        </div>
    }

    <!-- üå§Ô∏è Clima actual -->
    @if (ViewBag.Temp != null && ViewBag.Clima != null)
    {
        <div class="mt-2">
            <i class="bi bi-cloud-sun"></i>
            <span><strong>Clima:</strong> @ViewBag.Clima, @ViewBag.Temp&nbsp;¬∞C</span>
        </div>
    }

    <!-- Mapa -->
    <div id="map" style="height:300px;border-radius:.5rem;margin-top:10px;"></div>
  </div>

  <!-- Bot√≥n volver -->
  <div class="mb-4">
    <a asp-controller="Propiedad" asp-action="Index" class="btn btn-outline-secondary">
      ‚Üê Volver a propiedades
    </a>
  </div>

  <!-- ===== RESE√ëAS HEADER ===== -->
  <h4 class="mt-4">Rese√±as (@(Model?.Resenas?.Count ?? 0))</h4>

  <!-- MENSAJES DE √âXITO/ERROR -->
  @if (TempData["Success"] != null)
  {
      <div class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="bi bi-check-circle-fill"></i> @TempData["Success"]
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
  }

  @if (TempData["Error"] != null)
  {
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="bi bi-exclamation-triangle-fill"></i> @TempData["Error"]
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
  }

  <!-- Puntuaci√≥n promedio -->
  @if (tieneResenas)
  {
      <div class="mb-3">
          <span class="text-warning">
              @for (int i = 1; i <= 5; i++)
              {
                  if (i <= promedioEntero)
                  {
                      <i class="bi bi-star-fill"></i>
                  }
                  else if (i == promedioEntero + 1 && promedio > promedioEntero)
                  {
                      <i class="bi bi-star-half"></i>
                  }
                  else
                  {
                      <i class="bi bi-star"></i>
                  }
              }
          </span>
          <span class="text-muted ms-2">@promedio.ToString("F1") de 5 (@rese√±as.Count @(rese√±as.Count == 1 ? "rese√±a" : "rese√±as"))</span>
      </div>
  }

  <!-- Lista de rese√±as -->
  @if (!tieneResenas)
  {
      <div class="text-center py-4 text-muted">
          <i class="bi bi-chat-quote display-4"></i>
          <p class="mt-2">A√∫n no hay rese√±as para esta propiedad.</p>
          <p class="small">S√© el primero en compartir tu experiencia.</p>
      </div>
  }
  else
  {
      <div class="list-group">
          @foreach (var r in rese√±as)
          {
              <div class="list-group-item">
                  <div class="d-flex justify-content-between align-items-start">
                      <div>
                          <div class="small text-muted">
                              @r.Fecha.ToLocalTime().ToString("yyyy-MM-dd") ‚Äî
                              @for (int s = 1; s <= 5; s++)
                              {
                                  if (s <= r.Puntuacion) { <i class="bi bi-star-fill text-warning"></i> }
                                  else { <i class="bi bi-star text-muted"></i> }
                              }
                              <span class="ms-2">/@r.Puntuacion/5</span>
                          </div>

                          <div class="fw-semibold">
                              @if (r.Usuario != null)
                              {
                                  @r.Usuario.UserName
                              }
                              else
                              {
                                  @r.UsuarioId
                              }
                          </div>
                      </div>

                      <div class="text-end">
                          @* Mostrar bot√≥n eliminar solo al autor o admin *@
                          @{
                              var userId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
                              var isAuthor = userId != null && userId == r.UsuarioId;
                              var isAdmin = User.IsInRole("Admin");
                          }
                          @if (isAuthor || isAdmin)
                          {
                              <form asp-controller="Resena" asp-action="Delete" method="post" onsubmit="return confirm('¬øEliminar rese√±a?');">
                                  @Html.AntiForgeryToken()
                                  <input type="hidden" name="id" value="@r.Id" />
                                  <button type="submit" class="btn btn-link text-danger btn-sm">Eliminar</button>
                              </form>
                          }
                      </div>
                  </div>

                  <div class="mt-2">@r.Comentario</div>
              </div>
          }
      </div>
  }

  <hr />

  <!-- Formulario para dejar rese√±a -->
  @if (User.Identity?.IsAuthenticated ?? false)
  {
      <div class="mt-3">
          <h5>Dejar una rese√±a</h5>
          <form asp-controller="Resena" asp-action="Create" method="post" class="mt-2">
              @Html.AntiForgeryToken()
              <input type="hidden" name="propiedadId" value="@Model?.Id.ToString()" />

              <div class="mb-2">
                  <label class="form-label">Puntuaci√≥n</label>
                  <select name="puntuacion" class="form-select" required>
                      <option value="">Selecciona...</option>
                      <option value="5">‚≠ê 5 - Excelente</option>
                      <option value="4">‚≠ê 4 - Muy bueno</option>
                      <option value="3">‚≠ê 3 - Aceptable</option>
                      <option value="2">‚≠ê 2 - Regular</option>
                      <option value="1">‚≠ê 1 - Malo</option>
                  </select>
              </div>

              <div class="mb-3">
                  <label class="form-label">Comentario</label>
                  <textarea name="comentario" class="form-control" rows="3" maxlength="300" placeholder="Escribe tu opini√≥n..." required></textarea>
              </div>

              <button type="submit" class="btn btn-primary">Enviar rese√±a</button>
          </form>
      </div>
  }
  else
  {
      <div class="alert alert-light mt-3">
          <i class="bi bi-lock"></i> Inicia sesi√≥n para dejar una rese√±a.
      </div>
  }
</div>

@section Styles {
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
}

@section Scripts {
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Coordenadas desde el modelo o por defecto (Lima)
            var lat = @((Model?.Lat ?? -12.0464).ToString(System.Globalization.CultureInfo.InvariantCulture));
            var lng = @((Model?.Lng ?? -77.0428).ToString(System.Globalization.CultureInfo.InvariantCulture));

            // Inicializar mapa
            var map = L.map('map').setView([lat, lng], 14);

            // Capa base (OpenStreetMap gratuito)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> colaboradores'
            }).addTo(map);

            // Marcador
            L.marker([lat, lng]).addTo(map)
                .bindPopup("<b>@Model?.Titulo</b><br>@ubic")
                .openPopup();
        });
    </script>
}