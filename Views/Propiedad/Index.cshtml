@model IEnumerable<StayGo.Models.Propiedad>
@using StayGo.Models
@using System.Globalization

@{
    ViewData["Title"] = "Propiedades";
    var pe = new CultureInfo("es-PE");

    var total = (int)(ViewBag.Total ?? 0);
    var page = (int)(ViewBag.Page ?? 1);
    var pageSize = (int)(ViewBag.PageSize ?? 9);
    var q = (string?)ViewBag.Query;
    var tipo = (TipoPropiedad?)ViewBag.Tipo;
    var ciudad = (string?)ViewBag.Ciudad;
    var min = (decimal?)ViewBag.Min;
    var max = (decimal?)ViewBag.Max;
    var orden = (string?)ViewBag.Orden ?? "recientes";

    var totalPages = Math.Max(1, (int)Math.Ceiling(total / (double)pageSize));
    List<string> historialBusqueda = (List<string>)(ViewBag.HistorialBusqueda ?? new List<string>());
}

<div class="container py-5 propiedades-container">

    <!-- üè° T√≠tulo y descripci√≥n -->
    <div class="text-center mb-5">
        <h1 class="fw-bold display-6 text-sage-800">
            <i class="bi bi-houses"></i> Propiedades
        </h1>
        <p class="text-muted fs-5 mt-2">
            Descubre hoteles, casas y departamentos √∫nicos en cada destino.
        </p>
    </div>

    <!-- üîç Filtros -->
    <div class="card shadow-sm mb-5 border-0 rounded-4">
        <div class="card-body py-4 px-3">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-12 col-md-3">
                    <label class="form-label fw-semibold text-sage-700">Buscar</label>
                    <input class="form-control" name="q" value="@q" placeholder="T√≠tulo, direcci√≥n..." list="propiedad-search-history" />
                    <datalist id="propiedad-search-history">
                        @foreach (var item in historialBusqueda)
                        {
                            <option value="@item"></option>
                        }
                    </datalist>
                </div>

                <div class="col-6 col-md-2">
                    <label class="form-label fw-semibold text-sage-700">Tipo</label>
                    <select class="form-select" name="tipo">
                        <option value="">-- Todos --</option>
                        @foreach (var val in Enum.GetValues<TipoPropiedad>())
                        {
                            <option value="@val" selected="@(tipo == val)">@val</option>
                        }
                    </select>
                </div>

                <div class="col-6 col-md-2">
                    <label class="form-label fw-semibold text-sage-700">Ciudad</label>
                    <input class="form-control" name="ciudad" value="@ciudad" />
                </div>

                <div class="col-6 col-md-2">
                    <label class="form-label fw-semibold text-sage-700">M√≠n</label>
                    <input class="form-control" type="number" step="0.01" name="min" value="@(min?.ToString())" />
                </div>

                <div class="col-6 col-md-2">
                    <label class="form-label fw-semibold text-sage-700">M√°x</label>
                    <input class="form-control" type="number" step="0.01" name="max" value="@(max?.ToString())" />
                </div>

                <div class="col-6 col-md-2">
                    <label class="form-label fw-semibold text-sage-700">Ordenar</label>
                    <select class="form-select" name="orden" onchange="this.form.submit()">
                        <option value="recientes" selected="@(orden=="recientes")">Recientes</option>
                        <option value="titulo" selected="@(orden=="titulo")">T√≠tulo</option>
                        <option value="precio_asc" selected="@(orden=="precio_asc")">Precio ‚Üë</option>
                        <option value="precio_desc" selected="@(orden=="precio_desc")">Precio ‚Üì</option>
                    </select>
                </div>

                <div class="col-12 col-md-2 d-grid mt-2">
                    <button class="btn btn-sage" type="submit"><i class="bi bi-funnel"></i> Aplicar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- üß± Listado -->
    @if (Model == null || !Model.Any())
    {
        <div class="alert alert-info text-center shadow-sm rounded-4">
            No hay propiedades disponibles con los filtros actuales.
        </div>
    }
    else
    {
        <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4">
            @foreach (var p in Model)
            {
                <div class="col propiedad-col">
                    <div class="card propiedad-card h-100 border-0">
                        <div class="position-relative">
                            <img class="card-img-top propiedad-img"
                                 src="@(p.Imagenes?.FirstOrDefault(i=>i.EsPrincipal)?.Url
                                        ?? $"https://picsum.photos/seed/{(p.Titulo??"prop").Replace(" ","_")}/600/400")"
                                 alt="@p.Titulo" />
                            <span class="badge propiedad-badge position-absolute top-0 start-0 m-2 px-3 py-2">
                                @p.Tipo
                            </span>
                            <!-- Bot√≥n de Favorito -->
                            <button class="btn-favorito position-absolute top-0 end-0 m-2"
                                    data-propiedad-id="@p.Id"
                                    onclick="toggleFavorito(this, '@p.Id')"
                                    title="Agregar a favoritos">
                                <i class="bi bi-heart"></i>
                            </button>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title fw-semibold text-sage-800">@p.Titulo</h5>

                            <p class="card-text text-muted mb-2">
                                <i class="bi bi-geo-alt"></i>
                                @(string.Join(", ", new[] { p.Direccion?.Ciudad, p.Direccion?.Pais }.Where(s => !string.IsNullOrWhiteSpace(s)) ))
                            </p>

                            <p class="mb-3 fs-5 text-sage-700">
                                @if (p.PrecioPorNoche.HasValue)
                                {
                                    <strong>@p.PrecioPorNoche.Value.ToString("C", pe)</strong> <small class="text-muted">/ noche</small>
                                }
                                else
                                {
                                    <span class="badge text-bg-secondary">Hotel (precio por habitaci√≥n)</span>
                                }
                            </p>

                            <div class="mt-auto d-flex gap-2">
                                <a asp-controller="Propiedad"
                                   asp-action="Details"
                                   asp-route-id="@p.Id"
                                   class="btn btn-outline-sage btn-sm">
                                    <i class="bi bi-eye"></i> Ver detalles
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- üìÑ Paginaci√≥n -->
        <nav class="mt-5">
            <ul class="pagination justify-content-center">
                <li class="page-item @(page <= 1 ? "disabled" : "")">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-q="@q" asp-route-tipo="@tipo" asp-route-ciudad="@ciudad"
                       asp-route-min="@min" asp-route-max="@max" asp-route-orden="@orden"
                       asp-route-page="@(page-1)" asp-route-pageSize="@pageSize">Anterior</a>
                </li>

                @for (int i = 1; i <= totalPages; i++)
                {
                    <li class="page-item @(i == page ? "active" : "")">
                        <a class="page-link"
                           asp-action="Index"
                           asp-route-q="@q" asp-route-tipo="@tipo" asp-route-ciudad="@ciudad"
                           asp-route-min="@min" asp-route-max="@max" asp-route-orden="@orden"
                           asp-route-page="@i" asp-route-pageSize="@pageSize">@i</a>
                    </li>
                }

                <li class="page-item @(page >= totalPages ? "disabled" : "")">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-q="@q" asp-route-tipo="@tipo" asp-route-ciudad="@ciudad"
                       asp-route-min="@min" asp-route-max="@max" asp-route-orden="@orden"
                       asp-route-page="@(page+1)" asp-route-pageSize="@pageSize">Siguiente</a>
                </li>
            </ul>
        </nav>
    }
</div>

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --sage-50:#f5f7f4; --sage-100:#e9efe6; --sage-200:#dce6d7; --sage-300:#c9d7c2;
            --sage-400:#a3b18a; --sage-500:#7fa174; --sage-600:#5e8a63; --sage-700:#3f6b4f;
            --sage-800:#2f5b45; --sage-900:#26453a;
            --ink:#243036; --muted:#6c757d; --card:#ffffff;
            --shadow: 0 10px 25px rgba(36,48,54,.08);
            --radius: 18px;
            --ring: rgba(63,107,79,.35);
        }

        body {
            font-family: "Montserrat", sans-serif;
            background-color: var(--sage-50);
            color: var(--ink);
        }

        .text-sage-700 { color: var(--sage-700); }
        .text-sage-800 { color: var(--sage-800); }

        .btn-sage {
            background-color: var(--sage-600);
            border: none;
            color: #fff;
            transition: all .3s ease;
            border-radius: .6rem;
            font-weight: 500;
        }
        .btn-sage:hover {
            background-color: var(--sage-700);
            transform: translateY(-2px);
        }

        .btn-outline-sage {
            border: 1.6px solid var(--sage-500);
            color: var(--sage-700);
            transition: all .3s ease;
            border-radius: .6rem;
        }
        .btn-outline-sage:hover {
            background-color: var(--sage-600);
            color: #fff;
        }

        .propiedad-img {
            width: 100%;
            height: 230px;
            object-fit: cover;
            border-top-left-radius: var(--radius);
            border-top-right-radius: var(--radius);
        }

        /* ========== ANIMACI√ìN DE CARGA ========== */
        @@keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .propiedad-col {
            animation: slideInUp 0.6s ease-out forwards;
        }

        .propiedad-col:nth-child(1) { animation-delay: 0.1s; }
        .propiedad-col:nth-child(2) { animation-delay: 0.2s; }
        .propiedad-col:nth-child(3) { animation-delay: 0.3s; }
        .propiedad-col:nth-child(4) { animation-delay: 0.4s; }
        .propiedad-col:nth-child(5) { animation-delay: 0.5s; }
        .propiedad-col:nth-child(6) { animation-delay: 0.6s; }
        .propiedad-col:nth-child(7) { animation-delay: 0.7s; }
        .propiedad-col:nth-child(8) { animation-delay: 0.8s; }
        .propiedad-col:nth-child(9) { animation-delay: 0.9s; }

        /* ========== TARJETA DE PROPIEDAD ========== */
        .propiedad-card {
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
                        box-shadow 0.4s ease,
                        border-color 0.3s ease;
            border-radius: var(--radius);
            background: var(--card);
            box-shadow: var(--shadow);
            border: 2px solid transparent;
            overflow: hidden;
        }

        .propiedad-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(36,48,54,.15);
            border-color: var(--sage-300);
        }

        /* ========== IMAGEN DE PROPIEDAD ========== */
        .propiedad-img {
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .propiedad-card:hover .propiedad-img {
            transform: scale(1.08);
        }

        /* ========== BOT√ìN DE FAVORITO ========== */
        .btn-favorito {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            color: var(--sage-600);
            font-size: 1.3rem;
            padding: 0;
        }

        .btn-favorito:hover {
            background: var(--sage-600);
            color: white;
            transform: scale(1.15);
            box-shadow: 0 6px 16px rgba(94, 138, 99, 0.3);
        }

        .btn-favorito.active {
            background: var(--sage-600);
            color: white;
            animation: heartBeat 0.6s ease-in-out;
        }

        .btn-favorito i {
            transition: transform 0.3s ease;
        }

        .btn-favorito.active i {
            transform: scale(1.2);
        }

        @@keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.3); }
            50% { transform: scale(1.1); }
        }

        .propiedad-badge {
            background: linear-gradient(90deg, var(--sage-600), var(--sage-800));
            font-size: .85rem;
            border-radius: .5rem;
        }

        .pagination .page-link {
            color: var(--sage-700);
            border-radius: .5rem;
        }

        .pagination .page-item.active .page-link {
            background-color: var(--sage-600);
            border-color: var(--sage-600);
            color: #fff;
        }
    </style>
}

@section Scripts {
    <script>
        // Cargar estado de favoritos al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', async function() {
            const buttons = document.querySelectorAll('.btn-favorito');

            for (const btn of buttons) {
                const propiedadId = btn.getAttribute('data-propiedad-id');
                try {
                    const response = await fetch(`/Propiedad/IsFavorite/${propiedadId}`);

                    // Si no est√° autenticado (401), saltar
                    if (!response.ok) {
                        console.log('Usuario no autenticado o error en la solicitud');
                        continue;
                    }

                    const data = await response.json();

                    if (data.success && data.isFavorite) {
                        btn.classList.add('active');
                        btn.innerHTML = '<i class="bi bi-heart-fill"></i>';
                        btn.title = 'Remover de favoritos';
                    } else {
                        btn.classList.remove('active');
                        btn.innerHTML = '<i class="bi bi-heart"></i>';
                        btn.title = 'Agregar a favoritos';
                    }
                } catch (error) {
                    console.error('Error al verificar favorito:', error);
                }
            }
        });

        // Funci√≥n para toggle de favorito
        async function toggleFavorito(button, propiedadId) {
            // Verificar si el usuario est√° autenticado
            const isAuthenticated = @(User.Identity?.IsAuthenticated == true ? "true" : "false");

            if (isAuthenticated === "false") {
                alert('Debes iniciar sesi√≥n para agregar favoritos');
                window.location.href = '/Identity/Account/Login';
                return;
            }

            try {
                const response = await fetch('/Propiedad/ToggleFavorito', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify({ propiedadId: propiedadId })
                });

                const data = await response.json();

                if (data.success) {
                    if (data.isFavorite) {
                        button.classList.add('active');
                        button.innerHTML = '<i class="bi bi-heart-fill"></i>';
                        button.title = 'Remover de favoritos';
                    } else {
                        button.classList.remove('active');
                        button.innerHTML = '<i class="bi bi-heart"></i>';
                        button.title = 'Agregar a favoritos';
                    }
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al procesar la solicitud');
            }
        }
    </script>
}
    