@model IEnumerable<StayGo.Models.ContactoMensaje>

@{
    ViewData["Title"] = "Mensajes de Contacto";
    // Función de truncamiento mejorada para accesibilidad
    string Trunc(string? s, int max) =>
        string.IsNullOrWhiteSpace(s) ? "—" : (s!.Length <= max ? s : s.Substring(0, max) + "...");
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<div class="container py-5">
    
    <div class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom border-sage-200">
        <h2 class="title-main-sage">
            <i class="bi bi-inbox-fill me-3 text-sage-700"></i>Bandeja de Mensajes
        </h2>
        <span class="badge count-pill-sage">
            @(Model.Count()) Mensajes
        </span>
    </div>

    <div class="card shadow-lg border-0 table-card-sage">
        <div class="card-body p-0">
            @if (!Model.Any())
            {
                <div class="empty-state-sage p-5 text-center">
                    <i class="bi bi-chat-left-text-fill fs-1 mb-3 text-sage-500"></i>
                    <h5 class="fw-bold text-title-sage">No hay mensajes de contacto recientes</h5>
                    <p class="text-muted">La bandeja está vacía. ¡Buen trabajo de soporte!</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-sage-modern align-middle mb-0">
                        <thead>
                            <tr>
                                <th class="col-date"><i class="bi bi-clock me-2"></i>Fecha</th>
                                <th class="col-name"><i class="bi bi-person-fill me-2"></i>Nombre</th>
                                <th class="col-email"><i class="bi bi-envelope-fill me-2"></i>Email</th>
                                <th class="col-user"><i class="bi bi-person-badge-fill me-2"></i>Tipo de Usuario</th>
                                <th class="col-message"><i class="bi bi-chat-dots-fill me-2"></i>Mensaje</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var m in Model.OrderByDescending(x => x.FechaUtc))
                            {
                                <tr class="message-row-sage">
                                    <td>
                                        <div class="date-display-sage">
                                            @m.FechaUtc.ToLocalTime().ToString("dd/MM/yy")
                                            <small class="d-block text-muted">@m.FechaUtc.ToLocalTime().ToString("hh:mm tt")</small>
                                        </div>
                                    </td>
                                    <td class="fw-semibold text-title-sage">@(string.IsNullOrWhiteSpace(m.Nombre) ? "—" : m.Nombre)</td>
                                    <td>
                                        <a href="mailto:@m.Email" class="text-sage-700 fw-medium">
                                            @m.Email
                                        </a>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrWhiteSpace(m.IdentityUserId))
                                        {
                                            <span class="badge user-badge-registered">
                                                <i class="bi bi-check-circle-fill me-1"></i>Registrado
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge user-badge-guest">
                                                <i class="bi bi-box-arrow-in-right me-1"></i>Invitado
                                            </span>
                                        }
                                    </td>
                                    <td class="text-wrap message-truncate">@Trunc(m.Mensaje, 100)</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@section Styles{
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">

    <style>
        :root{
            /* Paleta Sage */
            --sage-50:#f5f7f4; 
            --sage-100:#e9efe6; 
            --sage-200:#dce6d7; 
            --sage-500:#7fa174; 
            --sage-700:#3f6b4f; /* Acento principal */
            --sage-800:#2f5b45; 
            --sage-900:#26453a;
            
            /* Colores de texto y fondo */
            --bg-page: var(--sage-50);
            --bg-card: #ffffff;
            --text-ink: #212529;
            --text-title: var(--sage-900);
            
            /* Sombra y bordes */
            --shadow-lg: 0 16px 40px rgba(0,0,0,.1), 0 2px 8px rgba(0,0,0,.08);
            --shadow-hover: 0 20px 50px rgba(0,0,0,.15);
            --rounded-xl: 1.5rem;
        }

        body{
            background-color: var(--bg-page);
            font-family: 'Inter', sans-serif;
            color: var(--text-ink);
        }

        .text-sage-700 { color: var(--sage-700) !important; }
        .border-sage-200 { border-color: var(--sage-200) !important; }
        .text-title-sage { color: var(--text-title); }

        /* Título Principal */
        .title-main-sage {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            font-size: 2rem;
            color: var(--text-title);
            display: flex;
            align-items: center;
        }
        
        /* Pill Contador */
        .count-pill-sage {
            background: var(--sage-700);
            color: white;
            padding: 0.5rem 1.2rem;
            font-weight: 600;
            font-size: 0.95rem;
            border-radius: 999px;
        }

        /* CARD DE LA TABLA (Luminosidad) */
        .table-card-sage {
            border-radius: var(--rounded-xl);
            box-shadow: var(--shadow-lg);
            background: var(--bg-card);
        }

        /* ESTADO VACÍO */
        .empty-state-sage {
            border-radius: var(--rounded-xl);
            background: var(--sage-50);
            border: 2px dashed var(--sage-200);
            margin: 2rem;
        }

        /* TABLA MODERNA SAGE */
        .table-sage-modern {
            /* Restablece Bootstrap */
            --bs-table-bg: var(--bg-card);
            --bs-table-striped-bg: var(--sage-50);
            --bs-table-hover-bg: var(--sage-100);
            
            /* Bordes interiores suaves */
            border-collapse: separate;
            border-spacing: 0 0.5rem; 
            padding: 0 1.5rem;
        }
        
        .table-sage-modern thead th {
            border-bottom: 2px solid var(--sage-200);
            color: var(--sage-800);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 1.5rem 1rem 0.8rem 1rem;
        }

        .table-sage-modern tbody tr {
            transition: all 0.2s ease;
            cursor: pointer;
            box-shadow: 0 0 0 1px var(--sage-200); /* Borde suave de fila */
        }
        
        .table-sage-modern tbody tr:hover {
            box-shadow: 0 4px 15px rgba(63, 107, 79, 0.15); /* Sombra al pasar el mouse */
            transform: translateY(-2px);
            background-color: var(--sage-100) !important;
        }

        .table-sage-modern td {
            border: none;
            padding: 1rem;
            color: var(--text-ink);
            background: white; /* Asegura el fondo blanco en las celdas */
        }
        
        .message-row-sage td:first-child { 
            border-top-left-radius: 1rem;
            border-bottom-left-radius: 1rem;
        }
        .message-row-sage td:last-child { 
            border-top-right-radius: 1rem;
            border-bottom-right-radius: 1rem;
        }
        
        /* DATOS ESPECÍFICOS */
        .date-display-sage {
            font-weight: 700;
            color: var(--sage-800);
            font-size: 1.05rem;
            line-height: 1.3;
        }
        
        .message-truncate {
            max-width: 350px;
            white-space: normal;
            font-size: 0.95rem;
            line-height: 1.4;
            color: var(--text-ink);
        }
        
        /* Badges de Usuario (Coherente con la paleta) */
        .user-badge-registered {
            background-color: var(--sage-700);
            color: white;
            font-weight: 600;
            padding: 0.5em 0.8em;
        }
        
        .user-badge-guest {
            background-color: var(--sage-500);
            color: white;
            font-weight: 600;
            padding: 0.5em 0.8em;
        }

        /* Column Widths (Opional, para mejor estructura) */
        .col-date { width: 12%; }
        .col-name { width: 15%; }
        .col-email { width: 20%; }
        .col-user { width: 13%; }
        .col-message { width: 40%; }
        
        /* Ajuste para vista móvil */
        @@media (max-width: 992px) {
             .title-main-sage { font-size: 1.5rem; }
             .table-card-sage { border-radius: 1rem; }
             .table-sage-modern td:first-child,
             .table-sage-modern td:last-child { border-radius: 0.5rem; }
             .message-truncate { max-width: 250px; }
        }

    </style>
}